# 实施计划：食物热量扫描器

## 概述

本实施计划将食物热量扫描器分解为可执行的开发任务。采用前后端并行开发的方式，优先实现核心功能，然后添加错误处理和优化。每个任务都包含具体的实现步骤和需求引用。

## 任务列表

- [ ] 1. 项目初始化和基础设置
  - 创建项目目录结构（前端和后端分离）
  - 初始化package.json和依赖安装
  - 配置Vitest测试环境
  - 设置ESLint和Prettier代码规范
  - 创建基础HTML页面结构
  - _需求：1.1, 6.1_

- [ ] 2. 实现前端摄像头模块
  - [ ] 2.1 创建CameraModule类
    - 实现openCamera()方法，使用getUserMedia API
    - 配置后置摄像头（facingMode: 'environment'）
    - 实现capturePhoto()方法，使用Canvas捕获图片
    - 实现closeCamera()方法释放资源
    - 实现isSupported()静态方法检查浏览器支持
    - _需求：2.1, 2.2, 2.3, 2.4_

  - [ ]* 2.2 编写摄像头模块的属性测试
    - **属性2：摄像头权限请求触发**
    - **验证需求：2.1**

  - [ ]* 2.3 编写摄像头模块的属性测试
    - **属性3：后置摄像头配置**
    - **验证需求：2.2**

  - [ ]* 2.4 编写摄像头模块的属性测试
    - **属性5：图片捕获生成**
    - **验证需求：2.4**

  - [ ]* 2.5 编写摄像头错误处理的单元测试
    - 测试权限拒绝场景（NotAllowedError）
    - 测试设备不存在场景（NotFoundError）
    - 测试设备被占用场景（NotReadableError）
    - _需求：2.5, 7.3_

- [ ] 3. 实现前端图片上传模块
  - [ ] 3.1 创建ImageUploader类
    - 实现compressImage()方法，使用Canvas压缩图片
    - 实现uploadImage()方法，使用Fetch API上传
    - 实现上传进度监控
    - 添加超时控制（30秒）
    - _需求：3.1, 3.2, 3.5_

  - [ ]* 3.2 编写图片压缩的属性测试
    - **属性9：图片自动压缩**
    - **验证需求：3.5, 9.5**

  - [ ]* 3.3 编写上传流程的单元测试
    - 测试上传成功场景
    - 测试上传失败和重试场景
    - 测试网络超时场景
    - _需求：3.3, 3.4, 7.2_

- [ ] 4. 实现前端UI控制器和状态管理
  - [ ] 4.1 创建AppState类
    - 定义状态枚举（IDLE, CAMERA_OPEN, UPLOADING, PROCESSING, RESULT, ERROR）
    - 实现状态转换逻辑
    - 实现观察者模式（subscribe/unsubscribe）
    - _需求：3.3_

  - [ ] 4.2 创建UIController类
    - 实现showLoading()和hideLoading()方法
    - 实现displayResult()方法展示识别结果
    - 实现showError()方法显示错误信息
    - 实现updateProgress()方法更新进度条
    - 实现reset()方法重置UI
    - _需求：3.2, 5.1, 5.2, 5.3, 5.5, 7.1_

  - [ ]* 4.3 编写UI元素尺寸的属性测试
    - **属性12：按钮触摸尺寸标准**
    - **验证需求：6.2**

  - [ ]* 4.4 编写字体大小的属性测试
    - **属性13：字体大小可读性**
    - **验证需求：6.3**

  - [ ]* 4.5 编写交互反馈的属性测试
    - **属性14：交互视觉反馈**
    - **验证需求：6.5**

- [ ] 5. 实现前端主应用逻辑
  - [ ] 5.1 创建主应用类App
    - 初始化所有模块（Camera, Uploader, UI, State）
    - 实现拍照按钮点击处理
    - 实现拍照后自动上传流程
    - 实现重试和重新拍照逻辑
    - 连接所有组件形成完整流程
    - _需求：1.1, 2.1, 3.1, 5.5_

  - [ ]* 5.2 编写完整流程的集成测试
    - 测试从拍照到显示结果的完整流程
    - 测试状态转换的正确性
    - _需求：1.1, 2.1, 3.1, 3.3_

- [ ] 6. 检查点 - 前端核心功能完成
  - 确保所有前端测试通过
  - 在浏览器中手动测试摄像头和UI交互
  - 如有问题请向用户提问

- [ ] 7. 实现后端项目设置
  - [ ] 7.1 创建Express服务器基础结构
    - 初始化Express应用
    - 配置CORS中间件
    - 配置body-parser和错误处理中间件
    - 创建健康检查端点（GET /api/health）
    - _需求：8.1_

  - [ ] 7.2 配置环境变量
    - 创建.env.example文件
    - 配置dotenv加载环境变量
    - 验证必需的环境变量（OPENAI_API_KEY）
    - _需求：8.5_

- [ ] 8. 实现后端文件上传处理
  - [ ] 8.1 配置Multer文件上传
    - 配置内存存储
    - 设置文件大小限制（10MB）
    - 实现文件类型过滤（JPEG, PNG, WebP）
    - _需求：8.1, 8.2_

  - [ ] 8.2 实现图片预处理
    - 使用Sharp调整图片大小（最大1024x1024）
    - 转换为JPEG格式并压缩（质量85%）
    - _需求：9.5_

  - [ ]* 8.3 编写文件验证的属性测试
    - **属性16：后端图片格式验证**
    - **验证需求：8.2**

  - [ ]* 8.4 编写文件处理的单元测试
    - 测试有效格式的接受
    - 测试无效格式的拒绝
    - 测试文件过大的拒绝
    - _需求：8.2, 7.1_

- [ ] 9. 实现OpenAI Vision服务
  - [ ] 9.1 创建OpenAIVisionService类
    - 实现analyzeFood()方法
    - 构建优化的提示词（中文，要求JSON格式）
    - 将图片转换为base64编码
    - 调用OpenAI API（gpt-4o或gpt-4-vision-preview）
    - 解析JSON响应并提取食物信息
    - 实现重试机制（最多3次，指数退避）
    - 添加超时控制（30秒）
    - _需求：4.1, 4.2, 4.3_

  - [ ]* 9.2 编写OpenAI服务的单元测试
    - 测试成功识别场景（使用mock）
    - 测试API失败和重试场景
    - 测试超时场景
    - 测试响应解析错误场景
    - _需求：4.4, 4.5, 7.1_

- [ ] 10. 实现后端API路由
  - [ ] 10.1 创建POST /api/analyze端点
    - 接收multipart/form-data图片上传
    - 调用文件验证和预处理
    - 调用OpenAI服务进行识别
    - 格式化并返回标准JSON响应
    - _需求：8.1, 8.3, 8.4_

  - [ ]* 10.2 编写API端点的属性测试
    - **属性17：后端API处理流程**
    - **验证需求：8.3, 8.4**

  - [ ]* 10.3 编写API端点的属性测试
    - **属性18：API密钥安全性**
    - **验证需求：8.5**

  - [ ]* 10.4 编写API响应格式的属性测试
    - **属性11：识别结果完整性**
    - **验证需求：5.1, 5.2, 5.3, 5.5**

- [ ] 11. 实现后端错误处理
  - [ ] 11.1 创建ErrorHandler类和错误中间件
    - 定义错误代码常量
    - 实现错误分类逻辑
    - 创建用户友好的中文错误消息
    - 实现Express错误处理中间件
    - _需求：7.1, 7.2, 7.4, 7.5_

  - [ ]* 11.2 编写错误处理的属性测试
    - **属性15：错误消息中文显示**
    - **验证需求：7.1, 7.4**

  - [ ]* 11.3 编写错误处理的单元测试
    - 测试各种错误类型的处理
    - 测试错误响应格式
    - _需求：7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 12. 检查点 - 后端核心功能完成
  - 确保所有后端测试通过
  - 使用Postman或curl测试API端点
  - 验证OpenAI API集成正常工作
  - 如有问题请向用户提问

- [ ] 13. 前后端集成
  - [ ] 13.1 配置前端API基础URL
    - 创建config.js配置文件
    - 设置开发和生产环境的API URL
    - _需求：8.1_

  - [ ] 13.2 更新ImageUploader连接后端API
    - 修改uploadImage()方法调用真实API
    - 处理API响应和错误
    - _需求：3.3, 3.4_

  - [ ]* 13.3 编写端到端集成测试
    - 测试完整的拍照→上传→识别→显示流程
    - 使用模拟的后端API
    - _需求：1.1, 2.1, 3.1, 4.1, 5.1_

- [ ] 14. 实现前端样式和响应式设计
  - [ ] 14.1 创建CSS样式文件
    - 实现移动优先的响应式布局
    - 设置按钮尺寸（最小44x44px）
    - 设置字体大小（最小16px）
    - 实现高对比度配色方案
    - 添加加载动画和过渡效果
    - 实现按钮点击视觉反馈
    - _需求：1.2, 6.2, 6.3, 6.4, 6.5_

  - [ ]* 14.2 编写响应式布局的属性测试
    - **属性1：响应式布局适配**
    - **验证需求：1.2**

  - [ ]* 14.3 编写样式的单元测试
    - 测试不同视口尺寸下的布局
    - 测试按钮和文字尺寸
    - _需求：1.2, 6.2, 6.3_

- [ ] 15. 实现前端错误处理UI
  - [ ] 15.1 创建ErrorHandler类
    - 实现错误分类和消息映射
    - 为不同错误类型提供中文提示
    - 决定是否显示重试按钮
    - _需求：7.1, 7.2, 7.3, 7.4, 7.5_

  - [ ] 15.2 在UIController中集成错误处理
    - 显示错误消息UI
    - 显示/隐藏重试按钮
    - 实现重试逻辑
    - _需求：7.1, 7.4_

  - [ ]* 15.3 编写错误处理的单元测试
    - 测试各种错误场景的UI显示
    - 测试重试按钮的显示逻辑
    - _需求：2.5, 3.4, 4.4, 4.5, 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 16. 性能优化
  - [ ] 16.1 优化前端性能
    - 实现图片懒加载
    - 优化CSS和JavaScript加载
    - 添加资源预加载提示
    - _需求：9.1, 9.2_

  - [ ] 16.2 优化后端性能
    - 实现响应压缩（gzip）
    - 优化图片处理性能
    - 添加请求日志
    - _需求：9.3, 9.4_

- [ ] 17. 浏览器兼容性测试和修复
  - [ ]* 17.1 编写浏览器兼容性测试
    - 测试iOS Safari 14+支持
    - 测试Android Chrome 90+支持
    - 测试Android Firefox 90+支持
    - 测试不支持摄像头API的降级处理
    - _需求：10.1, 10.2, 10.3, 10.4_

  - [ ] 17.2 修复兼容性问题
    - 根据测试结果修复发现的问题
    - 添加polyfill（如需要）
    - 实现特性检测和降级
    - _需求：10.4, 10.5_

- [ ] 18. 部署准备
  - [ ] 18.1 创建部署配置文件
    - 创建.env.example文件
    - 创建README.md部署说明
    - 配置生产环境构建脚本
    - _需求：8.5_

  - [ ] 18.2 添加安全配置
    - 配置CORS允许的域名
    - 实现API速率限制
    - 添加请求大小限制
    - 验证HTTPS配置
    - _需求：8.5_

- [ ] 19. 文档和用户指南
  - [ ] 19.1 创建用户使用说明
    - 编写中文使用指南
    - 说明如何授予摄像头权限
    - 说明如何获得最佳识别效果
    - 列出常见问题和解决方法
    - _需求：1.1, 2.1, 7.2, 7.3_

  - [ ] 19.2 创建开发者文档
    - 编写项目设置说明
    - 说明如何配置OpenAI API密钥
    - 说明如何本地运行和测试
    - 说明如何部署到生产环境
    - _需求：8.5_

- [ ] 20. 最终检查点 - 完整测试
  - 运行所有单元测试和属性测试
  - 在多个浏览器中手动测试完整流程
  - 验证所有需求都已实现
  - 验证所有18个正确性属性都有对应测试
  - 检查代码覆盖率（目标：80%+）
  - 如有问题请向用户提问

## 注意事项

- 标记为`*`的任务是可选的测试任务，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求编号，便于追溯
- 检查点任务确保增量验证和及时发现问题
- 属性测试任务明确标注了对应的设计文档属性编号
- 前后端可以并行开发，在任务13进行集成
